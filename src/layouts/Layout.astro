---
import "@/styles/global.css";
import {
	getLangFromUrl,
	useTranslations,
	getLocalizedPath,
	getDirection,
} from "@/i18n/utils";
import { languages, type Lang } from "@/i18n/ui";
import LanguageSwitcher from "@/components/LanguageSwitcher.astro";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const dir = getDirection(lang);

const currentPath = Astro.url.pathname;

// Helper to check if current path matches nav item
const isActive = (href: string) => {
	const localizedHref = getLocalizedPath(href, lang);
	if (href === "/") {
		return currentPath === localizedHref || currentPath === `/${lang}`;
	}
	return currentPath.startsWith(localizedHref);
};

const navItems = [
	{ href: "/", label: t("nav.overview") },
	{ href: "/search", label: t("nav.search") },
	{ href: "/projects", label: t("nav.projects") },
	{ href: "/bills", label: t("nav.bills") },
	{ href: "/budget", label: t("nav.budget") },
];
---

<!doctype html>
<html lang={lang} dir={dir}>
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link
			href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,600;9..40,700&family=Space+Mono:wght@400;700&family=Noto+Sans+Arabic:wght@400;500;600;700&display=swap"
			rel="stylesheet"
		/>
		<meta name="generator" content={Astro.generator} />
		<title>PM</title>
		<meta name="description" content="Project Management System" />
	</head>
	<body>
		<div class="min-h-screen">
			<!-- Top Navigation -->
			<header
				class="border-border bg-background/50 backdrop-blur-sm z-50 mx-auto"
			>
				<div class="max-w-6xl px-4 py-4 mx-auto">
					<nav class="flex items-center justify-between">
						<div class="flex items-center gap-12">
							<div class="flex items-center gap-2">
								<a
									href={getLocalizedPath("/", lang)}
									class="text-2xl font-bold tracking-tight italic"
								>
									PM
								</a>

								<!-- draw a logo of a project management system -->
								<svg
									xmlns="http://www.w3.org/2000/svg"
									width="24"
									height="24"
									viewBox="0 0 24 24"
									fill="none"
									stroke="currentColor"
									stroke-width="2"
									stroke-linecap="round"
									stroke-linejoin="round"
									class="size-6 mx-1 rotate-75"
								>
									<path d="M12 2L2 22h20L12 2z" rotate-75
									></path>
									<path d="M12 2L2 22h20L12 2z" rotate-75
									></path>
								</svg>
							</div>
							<div class="flex items-center gap-8">
								{
									navItems.map((item) => (
										<a
											href={getLocalizedPath(
												item.href,
												lang,
											)}
											class:list={[
												"text-sm font-medium transition-colors",
												isActive(item.href)
													? "text-foreground"
													: "text-muted-foreground hover:text-foreground",
											]}
										>
											{item.label}
										</a>
									))
								}
							</div>
						</div>
						<div class="flex items-center gap-4">
							<LanguageSwitcher />
							<button
								id="sign-out-btn"
								class="text-sm font-medium text-muted-foreground hover:text-foreground transition-colors"
							>
								{t("auth.logout")}
							</button>
						</div>
					</nav>
				</div>
			</header>

			<!-- Main Content -->
			<main class="max-w-6xl mx-auto px-6 py-16">
				<slot />
			</main>
		</div>

		<script>
			document
				.getElementById("sign-out-btn")
				?.addEventListener("click", async () => {
					try {
						const response = await fetch("/api/logout", {
							method: "POST",
						});

						if (response.ok) {
							window.location.href = "/login";
						}
					} catch (error) {
						console.error("Logout failed:", error);
					}
				});
		</script>
	</body>
</html>
