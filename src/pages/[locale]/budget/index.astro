---
import Layout from "@/layouts/Layout.astro";
import type {
	Budget,
	BudgetItem,
	Payment,
	Transfer,
	Obligation,
} from "@/types";
import {
	getLangFromUrl,
	useTranslations,
	getLocalizedPath,
	formatCurrency,
	formatDateFull,
} from "@/i18n/utils";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const pb = Astro.locals.pb;

// Get year from URL params, default to current year
const url = new URL(Astro.request.url);
const currentYear = new Date().getFullYear();
const selectedYear = parseInt(
	url.searchParams.get("year") || String(currentYear),
);

let budgets: Budget[] = [];
let allItems: BudgetItem[] = [];
let payments: Payment[] = [];
let transfers: Transfer[] = [];
let obligations: Obligation[] = [];

try {
	const [budgetsRes, itemsRes, paymentsRes, transfersRes, obligationsRes] =
		await Promise.all([
			pb.collection("budgets").getFullList<Budget>(),
			pb.collection("budget_items").getFullList<BudgetItem>({
				sort: "budget.ref",
				expand: "budget",
			}),
			pb.collection("payments").getFullList<Payment>({
				sort: "-created",
				expand: "budget,bill,project",
			}),
			pb.collection("transfers").getFullList<Transfer>({
				sort: "-created",
				expand: "from,to",
			}),
			pb.collection("obligations").getFullList<Obligation>({
				sort: "-created",
				expand: "budget,project,bill",
			}),
		]);

	budgets = budgetsRes;
	allItems = itemsRes;
	payments = paymentsRes;
	transfers = transfersRes;
	obligations = obligationsRes;
} catch (e) {
	console.error("Error fetching budget data:", e);
}

// Get unique years for filter dropdown
const availableYears = [...new Set(allItems.map((item) => item.year))].sort(
	(a, b) => b - a,
);
if (!availableYears.includes(currentYear)) {
	availableYears.unshift(currentYear);
}

// Filter items by selected year
const items = allItems.filter((item) => item.year === selectedYear);

// Filter obligations and payments by year (based on date field)
const yearStart = `${selectedYear}-01-01`;
const yearEnd = `${selectedYear}-12-31`;

const yearObligations = obligations.filter((o) => {
	const date = o.date || o.created;
	return date >= yearStart && date <= yearEnd;
});

const yearPayments = payments.filter((p) => {
	const date = p.created;
	return date >= yearStart && date <= yearEnd;
});

// Calculate totals for selected year
const totalCash = items.reduce((sum, item) => sum + (item.cash || 0), 0);
const totalCost = items.reduce((sum, item) => sum + (item.cost || 0), 0);
const totalObligatedCash = yearObligations.reduce(
	(sum, o) => sum + (o.cash || 0),
	0,
);
const totalObligatedCost = yearObligations.reduce(
	(sum, o) => sum + (o.cost || 0),
	0,
);
const totalSpent = yearPayments.reduce((sum, p) => sum + (p.amount || 0), 0);
const remaining = totalCash - totalObligatedCash;
const remainingCost = totalCost - totalObligatedCost;

// Calculate obligations and payments per budget
const getObligationsByBudget = (
	budgetId: string,
	type: "cash" | "cost" = "cash",
) =>
	yearObligations
		.filter((o) => o.budget === budgetId)
		.reduce((sum, o) => sum + (type === "cash" ? o.cash : o.cost || 0), 0);

const getPaymentsByBudget = (budgetId: string) =>
	yearPayments
		.filter((p) => p.budget_id === budgetId)
		.reduce((sum, p) => sum + (p.amount || 0), 0);

// Filter transfers for the year
const yearTransfers = transfers.filter((t) => {
	const date = t.created;
	return date >= yearStart && date <= yearEnd;
});

const basePath = getLocalizedPath("/budget", lang);
---

<Layout>
	<div class="space-y-20 md:space-y-28">
		<!-- Header with Year Filter -->
		<section>
			<div class="flex items-center justify-between gap-4 flex-wrap">
				<div>
					<h1 class="page-title">{t("budget.title")}</h1>
					<p class="page-subtitle">{t("budget.subtitle")}</p>
				</div>
				<div class="flex items-center gap-3">
					<label
						for="year-filter"
						class="text-sm text-muted-foreground"
					>
						{t("filter.year")}
					</label>
					<select
						id="year-filter"
						class="border border-border rounded-md px-3 py-2 text-sm bg-background font-mono min-w-24"
					>
						{
							availableYears.map((year) => (
								<option
									value={year}
									selected={year === selectedYear}
								>
									{year}
								</option>
							))
						}
					</select>
				</div>
			</div>

			<script define:vars={{ basePath }}>
				document
					.getElementById("year-filter")
					.addEventListener("change", function () {
						window.location.href = basePath + "?year=" + this.value;
					});
			</script>
		</section>

		<!-- Budget Summary Stats -->
		<section class="space-y-8">
			<!-- Hero Card: Total Budget Overview -->
			{(() => {
				const totalBudget = totalCash + totalCost;
				const totalObligated = totalObligatedCash + totalObligatedCost;
				const totalRemaining = remaining + remainingCost;
				const utilizationPercent = totalBudget > 0 ? Math.min((totalObligated / totalBudget) * 100, 100) : 0;
				const spentPercent = totalBudget > 0 ? Math.min((totalSpent / totalBudget) * 100, 100) : 0;
				const spendPercentOfCash = totalCash > 0 ? Math.min((totalSpent / totalCash) * 100, 100) : 0;

				return (
					<div class="border border-border rounded-lg p-8 md:p-10">
						<div class="grid grid-cols-1 md:grid-cols-3 gap-10 md:gap-16">
							<div>
								<span class="stat-label">{t("budget.total")}</span>
								<p class="stat-number arshid">{formatCurrency(totalBudget, lang)}</p>
							</div>
							<div>
								<span class="stat-label">{t("budget.totalObligated")}</span>
								<p class="stat-number arshid">{formatCurrency(totalObligated, lang)}</p>
							</div>
							<div>
								<span class="stat-label">{t("budget.totalRemaining")}</span>
								<p class:list={["stat-number arshid", totalRemaining < 0 ? "text-destructive" : "text-emerald-600"]}>
									{formatCurrency(totalRemaining, lang)}
								</p>
							</div>
						</div>
						
						<!-- Utilization Progress Bar -->
						<div class="mt-10 pt-8 border-t border-border">
							<div class="flex items-center justify-between mb-3">
								<span class="text-xs uppercase tracking-widest text-muted-foreground">{t("budget.utilization")}</span>
								<span class="text-sm font-mono tabular-nums text-muted-foreground">{utilizationPercent.toFixed(1)}%</span>
							</div>
							<div class="h-2 bg-muted rounded-full overflow-hidden">
								<div 
									class:list={["h-full rounded-full transition-all", utilizationPercent > 100 ? "bg-destructive" : utilizationPercent > 80 ? "bg-amber-500" : "bg-foreground"]}
									style={`width: ${Math.min(utilizationPercent, 100)}%`}
								/>
							</div>
						</div>

						<!-- Spent Progress Bar -->
						<div class="mt-6">
							<div class="flex items-center justify-between mb-3">
								<span class="text-xs uppercase tracking-widest text-muted-foreground">{t("common.spent")}</span>
								<span class="text-sm font-mono tabular-nums text-muted-foreground">
									{formatCurrency(totalSpent, lang)} ({spentPercent.toFixed(1)}%)
								</span>
							</div>
							<div class="h-2 bg-muted rounded-full overflow-hidden">
								<div 
									class="h-full rounded-full bg-emerald-600 transition-all"
									style={`width: ${Math.min(spentPercent, 100)}%`}
								/>
							</div>
						</div>
					</div>
				);
			})()}

			<!-- Cash & Cost Cards -->
			<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
				<!-- Cash Card -->
				{(() => {
					const cashUtilization = totalCash > 0 ? Math.min((totalObligatedCash / totalCash) * 100, 100) : 0;
					const spendPercentOfCash = totalCash > 0 ? Math.min((totalSpent / totalCash) * 100, 100) : 0;
					return (
						<div class="border border-border rounded-lg p-6 md:p-8">
							<div class="flex items-center gap-2 mb-6">
								<div class="w-3 h-3 rounded-full bg-foreground"></div>
								<span class="text-xs uppercase tracking-widest text-muted-foreground">{t("budget.cash")}</span>
							</div>
							
							<div class="grid grid-cols-3 gap-6">
								<div>
									<span class="text-xs text-muted-foreground">{t("budget.total")}</span>
									<p class="text-xl font-bold arshid mt-1">{formatCurrency(totalCash, lang)}</p>
								</div>
								<div>
									<span class="text-xs text-muted-foreground">{t("budget.obligated")}</span>
									<p class="text-xl arshid mt-1 text-muted-foreground">{formatCurrency(totalObligatedCash, lang)}</p>
								</div>
								<div>
									<span class="text-xs text-muted-foreground">{t("budget.remaining")}</span>
									<p class:list={["text-xl arshid mt-1 font-medium", remaining < 0 ? "text-destructive" : "text-emerald-600"]}>
										{formatCurrency(remaining, lang)}
									</p>
								</div>
							</div>

							<!-- Mini Progress -->
							<div class="mt-6 pt-4 border-t border-border">
								<div class="flex items-center justify-between mb-2">
									<span class="text-xs text-muted-foreground">{t("budget.utilization")}</span>
									<span class="text-xs font-mono tabular-nums text-muted-foreground">{cashUtilization.toFixed(0)}%</span>
								</div>
								<div class="h-1.5 bg-muted rounded-full overflow-hidden">
									<div 
										class:list={["h-full rounded-full transition-all", cashUtilization > 100 ? "bg-destructive" : "bg-foreground"]}
										style={`width: ${Math.min(cashUtilization, 100)}%`}
									/>
								</div>
							</div>
							<div class="mt-6 pt-4 border-border">
								<div class="flex items-center justify-between mb-2">
									<span class="text-xs text-muted-foreground">{t("common.spent")}</span>
									<span class="text-xs font-mono tabular-nums text-muted-foreground">{formatCurrency(totalSpent, lang)} ({spendPercentOfCash.toFixed(0)}%)</span>
								</div>
								<div class="h-1.5 bg-muted rounded-full overflow-hidden">
									<div 
										class:list={["h-full rounded-full transition-all", spendPercentOfCash > 100 ? "bg-destructive" : spendPercentOfCash > 80 ? "bg-amber-500" : "bg-emerald-600"]}
										style={`width: ${Math.min(spendPercentOfCash, 100)}%`}
									/>
								</div>
							</div>
						</div>
					);
				})()}

				<!-- Cost Card -->
				{(() => {
					const costUtilization = totalCost > 0 ? Math.min((totalObligatedCost / totalCost) * 100, 100) : 0;
					return (
						<div class="border border-border rounded-lg p-6 md:p-8">
							<div class="flex items-center gap-2 mb-6">
								<div class="w-3 h-3 rounded-full bg-muted-foreground"></div>
								<span class="text-xs uppercase tracking-widest text-muted-foreground">{t("budget.cost")}</span>
							</div>
							
							<div class="grid grid-cols-3 gap-6">
								<div>
									<span class="text-xs text-muted-foreground">{t("budget.total")}</span>
									<p class="text-xl font-bold arshid mt-1">{formatCurrency(totalCost, lang)}</p>
								</div>
								<div>
									<span class="text-xs text-muted-foreground">{t("budget.obligated")}</span>
									<p class="text-xl arshid mt-1 text-muted-foreground">{formatCurrency(totalObligatedCost, lang)}</p>
								</div>
								<div>
									<span class="text-xs text-muted-foreground">{t("budget.remaining")}</span>
									<p class:list={["text-xl arshid mt-1 font-medium", remainingCost < 0 ? "text-destructive" : "text-emerald-600"]}>
										{formatCurrency(remainingCost, lang)}
									</p>
								</div>
							</div>

							<!-- Mini Progress -->
							<div class="mt-6 pt-4 border-t border-border">
								<div class="flex items-center justify-between mb-2">
									<span class="text-xs text-muted-foreground">{t("budget.utilization")}</span>
									<span class="text-xs font-mono tabular-nums text-muted-foreground">{costUtilization.toFixed(0)}%</span>
								</div>
								<div class="h-1.5 bg-muted rounded-full overflow-hidden">
									<div 
										class:list={["h-full rounded-full transition-all", costUtilization > 100 ? "bg-destructive" : "bg-muted-foreground"]}
										style={`width: ${Math.min(costUtilization, 100)}%`}
									/>
								</div>
							</div>
						</div>
					);
				})()}
			</div>
		</section>

		<!-- Budget Items -->
		<section>
			<h2 class="section-title">{t("budget.items")} ({selectedYear})</h2>

			{
				items.length === 0 ? (
					<p class="text-muted-foreground py-12 text-center">
						{t("budget.noItemsFound")} {selectedYear}
					</p>
				) : (
					<div class="grid gap-6">
						{items.map((item) => {
							const budgetId = (item as any).budget;
							const obligatedCash = getObligationsByBudget(
								budgetId,
								"cash",
							);
							const obligatedCost = getObligationsByBudget(
								budgetId,
								"cost",
							);
							const paid = getPaymentsByBudget(budgetId);
							const availableCash =
								(item.cash || 0) - obligatedCash;
							const availableCost =
								(item.cost || 0) - obligatedCost;
							const budgetDetailPath = getLocalizedPath(
								`/budget/${budgetId}?year=${selectedYear}`,
								lang,
							);
							return (
								<a
									href={budgetDetailPath}
									class="block border border-border rounded-lg p-6 space-y-5 transition-colors hover:bg-muted/50"
								>
									{/* Header */}
									<div class="flex items-start justify-between gap-4">
										<div>
											<p class="font-medium text-lg leading-snug">
												{item.expand?.budget?.name ||
													"Unknown"}
											</p>
											{item.note && (
												<p class="text-sm text-muted-foreground mt-1.5">
													{item.note}
												</p>
											)}
										</div>
										<span class="mono text-xs text-muted-foreground bg-muted px-2.5 py-1 rounded">
											{item.expand?.budget?.ref || "—"}
										</span>
									</div>

									{/* Budget Amounts */}
									<div class="grid grid-cols-2 md:grid-cols-4 gap-6 pt-5 border-t border-border">
										<div>
											<p class="text-xs text-muted-foreground uppercase tracking-widest">
												{t("budget.cash")}
											</p>
											<p class="font-medium arshid mt-2 text-base">
												{formatCurrency(
													item.cash || 0,
													lang,
												)}
											</p>
										</div>
										<div>
											<p class="text-xs text-muted-foreground uppercase tracking-widest">
												{t("budget.cost")}
											</p>
											<p class="text-muted-foreground arshid mt-2">
												{formatCurrency(
													item.cost || 0,
													lang,
												)}
											</p>
										</div>
										<div>
											<p class="text-xs text-muted-foreground uppercase tracking-widest">
												{t("budget.obligatedCash")}
											</p>
											<p class="arshid mt-2">
												{formatCurrency(
													obligatedCash,
													lang,
												)}
											</p>
										</div>
										<div>
											<p class="text-xs text-muted-foreground uppercase tracking-widest">
												{t("budget.obligatedCost")}
											</p>
											<p class="arshid mt-2 text-muted-foreground">
												{formatCurrency(
													obligatedCost,
													lang,
												)}
											</p>
										</div>
									</div>

									{/* Remaining & Payments */}
									<div class="grid grid-cols-2 md:grid-cols-3 gap-6 pt-5 border-t border-border">
										<div>
											<p class="text-xs text-muted-foreground uppercase tracking-widest">
												{t("budget.payments")}
											</p>
											<p class="text-muted-foreground arshid mt-2">
												{formatCurrency(paid, lang)}
											</p>
										</div>
										<div>
											<p class="text-xs text-muted-foreground uppercase tracking-widest">
												{t("budget.remainingCash")}
											</p>
											<p
												class:list={[
													"font-medium arshid mt-2 text-base",
													availableCash < 0
														? "text-destructive"
														: "text-emerald-600",
												]}
											>
												{formatCurrency(
													availableCash,
													lang,
												)}
											</p>
										</div>
										<div>
											<p class="text-xs text-muted-foreground uppercase tracking-widest">
												{t("budget.remainingCost")}
											</p>
											<p
												class:list={[
													"arshid mt-2",
													availableCost < 0
														? "text-destructive"
														: "text-muted-foreground",
												]}
											>
												{formatCurrency(
													availableCost,
													lang,
												)}
											</p>
										</div>
									</div>
								</a>
							);
						})}
					</div>
				)
			}
		</section>

		<!-- Payments -->
		<section>
			<h2 class="section-title">
				{t("budget.payments")} ({selectedYear})
			</h2>

			{
				yearPayments.length === 0 ? (
					<p class="text-muted-foreground py-12 text-center">
						{t("budget.noPaymentsFound")} {selectedYear}
					</p>
				) : (
					<table class="data-table">
						<thead>
							<tr>
								<th>{t("table.ref")}</th>
								<th>{t("budget.title")}</th>
								<th>{t("budget.billProject")}</th>
								<th>{t("table.date")}</th>
								<th class="text-right">{t("table.amount")}</th>
							</tr>
						</thead>
						<tbody>
							{yearPayments.map((payment) => (
								<tr>
									<td class="arshid text-muted-foreground text-sm align-middle">
										{payment.ref}
									</td>
									<td class="align-middle font-medium">
										{payment.expand?.budget?.name || "—"}
									</td>
									<td class="align-middle text-muted-foreground">
										{payment.expand?.bill?.name ||
											payment.expand?.project?.name ||
											"—"}
									</td>
									<td class="text-muted-foreground align-middle">
										{formatDateFull(payment.created, lang)}
									</td>
									<td class="text-right font-medium arshid text-base align-middle">
										{formatCurrency(
											payment.amount || 0,
											lang,
										)}
									</td>
								</tr>
							))}
						</tbody>
					</table>
				)
			}
		</section>

		<!-- Transfers -->
		<section>
			<h2 class="section-title">
				{t("budget.transfers")} ({selectedYear})
			</h2>

			{
				yearTransfers.length === 0 ? (
					<p class="text-muted-foreground py-12 text-center">
						{t("budget.noTransfersFound")} {selectedYear}
					</p>
				) : (
					<table class="data-table">
						<thead>
							<tr>
								<th>{t("common.from")}</th>
								<th>{t("common.to")}</th>
								<th>{t("table.date")}</th>
								<th>{t("common.note")}</th>
								<th class="text-right">{t("budget.cash")}</th>
								<th class="text-right">{t("budget.cost")}</th>
							</tr>
						</thead>
						<tbody>
							{yearTransfers.map((transfer) => (
								<tr>
									<td class="font-medium align-middle">
										{transfer.expand?.from?.name ||
											transfer.from}
									</td>
									<td class="align-middle">
										{transfer.expand?.to?.name ||
											transfer.to}
									</td>
									<td class="text-muted-foreground align-middle">
										{formatDateFull(transfer.created, lang)}
									</td>
									<td class="text-muted-foreground text-sm max-w-xs truncate align-middle">
										{transfer.note || "—"}
									</td>
									<td class="text-right font-medium arshid text-base align-middle">
										{formatCurrency(
											transfer.cash || 0,
											lang,
										)}
									</td>
									<td class="text-right text-muted-foreground arshid align-middle">
										{formatCurrency(
											transfer.cost || 0,
											lang,
										)}
									</td>
								</tr>
							))}
						</tbody>
					</table>
				)
			}
		</section>

		<!-- Obligations -->
		<section>
			<h2 class="section-title">
				{t("budget.obligations")} ({selectedYear})
			</h2>

			{
				yearObligations.length === 0 ? (
					<p class="text-muted-foreground py-12 text-center">
						{t("budget.noObligationsFound")} {selectedYear}
					</p>
				) : (
					<table class="data-table">
						<thead>
							<tr>
								<th>{t("table.ref")}</th>
								<th>{t("budget.title")}</th>
								<th>{t("budget.projectBill")}</th>
								<th>{t("table.date")}</th>
								<th class="text-right">{t("budget.cash")}</th>
								<th class="text-right">{t("budget.cost")}</th>
							</tr>
						</thead>
						<tbody>
							{yearObligations.map((obligation) => (
								<tr>
									<td class="mono text-muted-foreground text-sm align-middle">
										{obligation.ref}
									</td>
									<td class="align-middle font-medium">
										{obligation.expand?.budget?.name || "—"}
									</td>
									<td class="align-middle text-muted-foreground">
										{obligation.expand?.project?.name ||
											obligation.expand?.bill?.name ||
											"—"}
									</td>
									<td class="text-muted-foreground align-middle">
										{formatDateFull(
											obligation.date ||
												obligation.created,
											lang,
										)}
									</td>
									<td class="text-right font-medium arshid text-base align-middle">
										{formatCurrency(
											obligation.cash || 0,
											lang,
										)}
									</td>
									<td class="text-right text-muted-foreground arshid align-middle">
										{formatCurrency(
											obligation.cost || 0,
											lang,
										)}
									</td>
								</tr>
							))}
						</tbody>
					</table>
				)
			}
		</section>
	</div>
</Layout>
