---
import Layout from "@/layouts/Layout.astro";
import PageHeader from "@/components/PageHeader.astro";
import StatsGrid from "@/components/StatsGrid.astro";
import StatItem from "@/components/StatItem.astro";
import DetailSection from "@/components/DetailSection.astro";
import DetailCard from "@/components/DetailCard.astro";
import EmptyState from "@/components/EmptyState.astro";
import {
	getLangFromUrl,
	useTranslations,
	getLocalizedPath,
	formatCurrency,
	formatDateFull,
} from "@/i18n/utils";
import { getProjectWithDetails } from "@/lib/data";
import type { Project, ProjectLog } from "@/types";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const pb = Astro.locals.pb;
const { id } = Astro.params;

const data = await getProjectWithDetails(pb, id!);
const project = data?.project ?? null;
const allPhases = data?.allPhases ?? [];
const obligations = data?.obligations ?? [];
const payments = data?.payments ?? [];
const logs = data?.logs ?? [];

// Helper to get file URL from PocketBase
const getFileUrl = (record: Project, filename: string) => {
	return pb.files.getURL(record, filename);
};

// Calculate totals
const totalObligatedCash = obligations.reduce(
	(sum, o) => sum + (o.cash || 0),
	0,
);
const totalObligatedCost = obligations.reduce(
	(sum, o) => sum + (o.cost || 0),
	0,
);
const totalPaid = payments.reduce((sum, p) => sum + (p.amount || 0), 0);
const remaining = totalObligatedCash - totalPaid;

const backPath = getLocalizedPath("/projects", lang);
---

<Layout>
	{
		!project ? (
			<div class="py-20 text-center">
				<p class="text-muted-foreground text-lg">
					{t("detail.projectNotFound")}
				</p>
				<a
					href={backPath}
					class="text-sm text-muted-foreground hover:text-foreground mt-4 inline-block"
				>
					← {t("detail.backToProjects")}
				</a>
			</div>
		) : (
			<div class="space-y-20 md:space-y-28">
				{/* Header */}
				<PageHeader
					title={project.name}
					subtitle={project.slug || project.ref}
					backHref={backPath}
					backLabel={t("detail.backToProjects")}
				>
					<div class="flex items-center gap-4 mt-6">
						<span
							class:list={[
								"status-dot",
								project.active
									? "status-dot-active"
									: "status-dot-inactive",
							]}
							title={
								project.active
									? t("filter.active")
									: t("filter.inactive")
							}
						/>
						<span class="text-sm text-muted-foreground">
							{project.active
								? t("filter.active")
								: t("filter.inactive")}
						</span>
					</div>
				</PageHeader>

				{/* Phases Timeline */}
				{allPhases.length > 0 &&
					(() => {
						const currentIndex = allPhases.findIndex(
							(p) => p.id === project.phase,
						);
						const startIndex = Math.max(0, currentIndex - 3);
						const endIndex = Math.min(
							allPhases.length - 1,
							currentIndex + 3,
						);
						const visiblePhases = allPhases.slice(
							startIndex,
							endIndex + 1,
						);
						const hasMoreBefore = startIndex > 0;
						const hasMoreAfter = endIndex < allPhases.length - 1;

						return (
							<div class="phase-timeline-wrapper">
								<p class="section-title">
									{t("detail.projectPhases")}
								</p>
								<div class="phase-timeline">
									{hasMoreBefore && (
										<div class="phase-more">
											<span class="text-muted-foreground text-xs">
												+{startIndex}
											</span>
										</div>
									)}
									{visiblePhases.map((phase, idx) => {
										const actualIndex = startIndex + idx;
										const isCurrent =
											project.phase === phase.id;
										const isPast =
											actualIndex < currentIndex;
										const isFirst = idx === 0;
										return (
											<div class="phase-item">
												{/* Connector line */}
												{!isFirst && (
													<div
														class:list={[
															"phase-connector",
															isPast &&
																"phase-connector-completed",
															isCurrent &&
																"phase-connector-completed",
														]}
													/>
												)}
												{hasMoreBefore && isFirst && (
													<div class="phase-connector phase-connector-completed" />
												)}
												{/* Phase dot and label */}
												<div class="phase-content">
													{isCurrent ? (
														<div class="phase-dot-current-wrapper">
															<div class="phase-dot-current-ring" />
															<div class="phase-dot-current" />
														</div>
													) : isPast ? (
														<div class="phase-dot-completed">
															<svg
																xmlns="http://www.w3.org/2000/svg"
																width="10"
																height="10"
																viewBox="0 0 24 24"
																fill="none"
																stroke="currentColor"
																stroke-width="3"
																stroke-linecap="round"
																stroke-linejoin="round"
																class="text-white"
															>
																<polyline points="20 6 9 17 4 12" />
															</svg>
														</div>
													) : (
														<div class="phase-dot-future" />
													)}
													<span
														class:list={[
															"phase-label",
															isCurrent &&
																"phase-label-current",
															isPast &&
																"phase-label-completed",
														]}
													>
														{phase.name}
													</span>
												</div>
											</div>
										);
									})}
									{hasMoreAfter && (
										<>
											<div class="phase-connector" />
											<div class="phase-more">
												<span class="text-muted-foreground text-xs">
													+
													{allPhases.length -
														1 -
														endIndex}
												</span>
											</div>
										</>
									)}
								</div>
							</div>
						);
					})()}

				{/* Project Info */}
				<DetailSection title={t("detail.overview")}>
					<StatsGrid columns={4}>
						<StatItem
							label={t("projects.totalValue")}
							value={formatCurrency(project.total || 0, lang)}
							size="md"
							mono
						/>
						<StatItem
							label={t("detail.startDate")}
							value={
								project.start_date
									? formatDateFull(project.start_date, lang)
									: t("common.tbd")
							}
							size="md"
							variant="muted"
						/>
						<StatItem
							label={t("detail.endDate")}
							value={
								project.end_date
									? formatDateFull(project.end_date, lang)
									: t("common.tbd")
							}
							size="md"
							variant="muted"
						/>
						<StatItem
							label={t("detail.duration")}
							value={project.duration || "—"}
							size="md"
							variant="muted"
						/>
					</StatsGrid>

					{/* Assignees */}
					{project.expand?.assignee &&
						project.expand.assignee.length > 0 && (
							<div class="mt-8 pt-8 border-t border-border">
								<p class="text-xs text-muted-foreground uppercase tracking-widest mb-4">
									{t("detail.assignees")}
								</p>
								<div class="flex flex-wrap gap-3">
									{project.expand.assignee.map((user) => (
										<div class="flex items-center gap-2 bg-muted px-3 py-2 rounded-md">
											<div class="w-7 h-7 rounded-full bg-background flex items-center justify-center text-xs font-medium">
												{user.name?.charAt(0) ||
													user.email?.charAt(0)}
											</div>
											<span class="text-sm">
												{user.name || user.email}
											</span>
										</div>
									))}
								</div>
							</div>
						)}
				</DetailSection>

				{/* Financials */}
				<DetailSection title={t("detail.financials")}>
					<StatsGrid columns={4}>
						<StatItem
							label={t("budget.obligatedCash")}
							value={formatCurrency(totalObligatedCash, lang)}
							size="md"
							mono
						/>
						<StatItem
							label={t("budget.obligatedCost")}
							value={formatCurrency(totalObligatedCost, lang)}
							size="md"
							variant="muted"
							mono
						/>
						<StatItem
							label={t("common.paid")}
							value={formatCurrency(totalPaid, lang)}
							size="md"
							mono
						/>
						<StatItem
							label={t("budget.remainingCash")}
							value={formatCurrency(remaining, lang)}
							size="md"
							variant={remaining < 0 ? "negative" : "positive"}
							mono
						/>
					</StatsGrid>
				</DetailSection>

				{/* Linked Obligations */}
				<DetailSection title={t("detail.linkedObligations")}>
					{obligations.length === 0 ? (
						<EmptyState message={t("detail.noObligations")} />
					) : (
						<table class="data-table">
							<thead>
								<tr>
									<th>{t("table.ref")}</th>
									<th>{t("budget.title")}</th>
									<th>{t("table.date")}</th>
									<th class="text-right">
										{t("budget.cash")}
									</th>
									<th class="text-right">
										{t("budget.cost")}
									</th>
								</tr>
							</thead>
							<tbody>
								{obligations.map((obligation) => (
									<tr>
										<td class="mono text-muted-foreground text-sm align-middle">
											{obligation.ref}
										</td>
										<td class="align-middle font-medium">
											{obligation.expand?.budget?.name ||
												"—"}
										</td>
										<td class="text-muted-foreground align-middle">
											{formatDateFull(
												obligation.date ||
													obligation.created,
												lang,
											)}
										</td>
										<td class="text-right font-medium arshid text-base align-middle">
											{formatCurrency(
												obligation.cash || 0,
												lang,
											)}
										</td>
										<td class="text-right text-muted-foreground arshid align-middle">
											{formatCurrency(
												obligation.cost || 0,
												lang,
											)}
										</td>
									</tr>
								))}
							</tbody>
						</table>
					)}
				</DetailSection>

				{/* Linked Payments */}
				<DetailSection title={t("detail.linkedPayments")}>
					{payments.length === 0 ? (
						<EmptyState message={t("detail.noPayments")} />
					) : (
						<table class="data-table">
							<thead>
								<tr>
									<th>{t("table.ref")}</th>
									<th>{t("budget.title")}</th>
									<th>{t("table.date")}</th>
									<th class="text-right">
										{t("table.amount")}
									</th>
								</tr>
							</thead>
							<tbody>
								{payments.map((payment) => (
									<tr>
										<td class="arshid text-muted-foreground text-sm align-middle">
											{payment.ref}
										</td>
										<td class="align-middle font-medium">
											{payment.expand?.budget?.name ||
												"—"}
										</td>
										<td class="text-muted-foreground align-middle">
											{formatDateFull(
												payment.created,
												lang,
											)}
										</td>
										<td class="text-right font-medium arshid text-base align-middle">
											{formatCurrency(
												payment.amount || 0,
												lang,
											)}
										</td>
									</tr>
								))}
							</tbody>
						</table>
					)}
				</DetailSection>

				{/* Activity Log */}
				<DetailSection title={t("detail.activityLog")}>
					{logs.length === 0 ? (
						<EmptyState message={t("detail.noActivity")} />
					) : (
						<div class="activity-timeline">
							{logs.map((log, idx) => {
								const isLast = idx === logs.length - 1;
								const phaseName = log.expand?.phase?.name ?? "—";
								const previousPhaseName = log.expand?.previous_phase?.name;
								const userName = log.expand?.by?.name ?? log.expand?.by?.email ?? "—";
								const logDate = new Date(log.created);
								
								return (
									<div class="activity-item">
										{/* Timeline connector */}
										<div class="activity-connector">
											<div class="activity-dot" />
											{!isLast && <div class="activity-line" />}
										</div>
										
										{/* Activity content */}
										<div class="activity-content">
											<div class="activity-header">
												<span class="activity-phase-change">
													{t("detail.phaseChangedTo")}{" "}
													<span class="badge badge-info">{phaseName}</span>
													{previousPhaseName && (
														<>
															{" "}{t("detail.phaseChangedFrom")}{" "}
															<span class="text-muted-foreground">{previousPhaseName}</span>
														</>
													)}
												</span>
											</div>
											<div class="activity-meta">
												<span class="activity-user">
													<span class="activity-user-avatar">
														{userName.charAt(0).toUpperCase()}
													</span>
													{userName}
												</span>
												<span class="activity-date">
													{formatDateFull(log.created, lang)}
												</span>
											</div>
											{log.note && (
												<p class="activity-note">{log.note}</p>
											)}
										</div>
									</div>
								);
							})}
						</div>
					)}
				</DetailSection>

				{/* Files & Attachments */}
				<DetailSection title={t("detail.filesAttachments")}>
					{!project.files || project.files.length === 0 ? (
						<EmptyState message={t("detail.noFiles")} />
					) : (
						<div class="files-grid">
							{project.files.map((file) => {
								const fileUrl = getFileUrl(project, file);
								const fileName = file;
								const fileExt =
									fileName.split(".").pop()?.toLowerCase() ||
									"";
								const isImage = [
									"jpg",
									"jpeg",
									"png",
									"gif",
									"webp",
									"svg",
								].includes(fileExt);
								const isPdf = fileExt === "pdf";
								const isDoc = [
									"doc",
									"docx",
									"xls",
									"xlsx",
									"ppt",
									"pptx",
								].includes(fileExt);

								return (
									<a
										href={fileUrl}
										target="_blank"
										rel="noopener noreferrer"
										class="file-card"
									>
										<div class="file-icon">
											{isImage ? (
												<svg
													xmlns="http://www.w3.org/2000/svg"
													width="24"
													height="24"
													viewBox="0 0 24 24"
													fill="none"
													stroke="currentColor"
													stroke-width="1.5"
													stroke-linecap="round"
													stroke-linejoin="round"
												>
													<rect
														width="18"
														height="18"
														x="3"
														y="3"
														rx="2"
														ry="2"
													/>
													<circle
														cx="9"
														cy="9"
														r="2"
													/>
													<path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21" />
												</svg>
											) : isPdf ? (
												<svg
													xmlns="http://www.w3.org/2000/svg"
													width="24"
													height="24"
													viewBox="0 0 24 24"
													fill="none"
													stroke="currentColor"
													stroke-width="1.5"
													stroke-linecap="round"
													stroke-linejoin="round"
												>
													<path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" />
													<polyline points="14 2 14 8 20 8" />
													<path d="M10 12a1 1 0 0 0-1 1v1a1 1 0 0 1-1 1 1 1 0 0 1 1 1v1a1 1 0 0 0 1 1" />
													<path d="M14 18a1 1 0 0 0 1-1v-1a1 1 0 0 1 1-1 1 1 0 0 1-1-1v-1a1 1 0 0 0-1-1" />
												</svg>
											) : isDoc ? (
												<svg
													xmlns="http://www.w3.org/2000/svg"
													width="24"
													height="24"
													viewBox="0 0 24 24"
													fill="none"
													stroke="currentColor"
													stroke-width="1.5"
													stroke-linecap="round"
													stroke-linejoin="round"
												>
													<path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" />
													<polyline points="14 2 14 8 20 8" />
													<line
														x1="16"
														x2="8"
														y1="13"
														y2="13"
													/>
													<line
														x1="16"
														x2="8"
														y1="17"
														y2="17"
													/>
													<line
														x1="10"
														x2="8"
														y1="9"
														y2="9"
													/>
												</svg>
											) : (
												<svg
													xmlns="http://www.w3.org/2000/svg"
													width="24"
													height="24"
													viewBox="0 0 24 24"
													fill="none"
													stroke="currentColor"
													stroke-width="1.5"
													stroke-linecap="round"
													stroke-linejoin="round"
												>
													<path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" />
													<polyline points="14 2 14 8 20 8" />
												</svg>
											)}
										</div>
										<div class="file-info">
											<span class="file-name">
												{fileName}
											</span>
											<span class="file-type">
												{fileExt.toUpperCase()}
											</span>
										</div>
									</a>
								);
							})}
						</div>
					)}
				</DetailSection>
			</div>
		)
	}
</Layout>
