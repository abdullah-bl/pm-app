---
import Layout from "@/layouts/Layout.astro";
import {
	getLangFromUrl,
	useTranslations,
	getLocalizedPath,
	formatCurrency,
	formatDate,
} from "@/i18n/utils";
import { getDashboardData } from "@/lib/data";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const pb = Astro.locals.pb;

const currentYear = new Date().getFullYear();

const {
	projects,
	plannedPayments,
	yearObligations,
	yearPayments,
	totalBudgetCash,
	totalObligatedCash,
	totalPaid,
	totalProjectValue,
	budgetRemainingCash,
} = await getDashboardData(pb, currentYear);

const recentProjects = projects.slice(0, 5);

// Payments breakdown by status for the current year
const paidPayments = yearPayments.filter((p) => p.status === "paid");
const pendingPayments = yearPayments.filter((p) => p.status === "pending");
const plannedYearPayments = yearPayments.filter((p) => p.status === "planned");

const totalPending = pendingPayments.reduce(
	(sum, p) => sum + (p.amount || 0),
	0,
);
const totalPlannedYear = plannedYearPayments.reduce(
	(sum, p) => sum + (p.amount || 0),
	0,
);
---

<Layout>
	<div class="space-y-24">
		<!-- Header -->
		<section>
			<p class="section-title mb-4">
				{currentYear}
				{t("dashboard.overview")}
			</p>
			<h1 class="page-title">{t("dashboard.title")}</h1>
		</section>

		<!-- Budget Summary - Primary Stats -->
		<section>
			<h2 class="section-title">{t("dashboard.budgetSummary")}</h2>
			<div class="grid grid-cols-1 md:grid-cols-3 gap-12 md:gap-16">
				<div>
					<span class="stat-label">{t("budget.cash")}</span>
					<p class="stat-number arshid">
						{formatCurrency(totalBudgetCash, lang)}
					</p>
				</div>
				<div>
					<span class="stat-label">{t("budget.obligatedCash")}</span>
					<p class="stat-number arshid">
						{formatCurrency(totalObligatedCash, lang)}
					</p>
				</div>
				<div>
					<span class="stat-label">{t("budget.remainingCash")}</span>
					<p
						class:list={[
							"stat-number arshid",
							budgetRemainingCash < 0
								? "text-destructive"
								: "text-emerald-600",
						]}
					>
						{formatCurrency(budgetRemainingCash, lang)}
					</p>
				</div>
			</div>
		</section>

		<!-- Payments Overview - Planned / Pending / Paid -->
		<section>
			<h2 class="section-title">{t("dashboard.paymentsOverview")}</h2>
			<div class="grid grid-cols-1 md:grid-cols-3 gap-12 md:gap-16">
				<!-- Planned -->
				<div class="border-s-4 border-blue-400 ps-6">
					<span class="stat-label">{t("payments.planned")}</span>
					<p class="stat-number-md arshid">
						{formatCurrency(totalPlannedYear, lang)}
					</p>
					<p class="text-muted-foreground mt-3">
						{plannedYearPayments.length}
						{t("budget.transactions")}
					</p>
				</div>
				<!-- Pending -->
				<div class="border-s-4 border-amber-400 ps-6">
					<span class="stat-label">{t("payments.pending")}</span>
					<p class="stat-number-md arshid">
						{formatCurrency(totalPending, lang)}
					</p>
					<p class="text-muted-foreground mt-3">
						{pendingPayments.length}
						{t("budget.transactions")}
					</p>
				</div>
				<!-- Paid -->
				<div class="border-s-4 border-emerald-400 ps-6">
					<span class="stat-label">{t("payments.paid")}</span>
					<p class="stat-number-md arshid">
						{formatCurrency(totalPaid, lang)}
					</p>
					<p class="text-muted-foreground mt-3">
						{paidPayments.length}
						{t("budget.transactions")}
					</p>
				</div>
			</div>
		</section>

		<!-- Projects & Obligations Summary -->
		<section>
			<h2 class="section-title">{t("dashboard.activity")}</h2>
			<div class="grid grid-cols-1 md:grid-cols-2 gap-12 md:gap-16">
				<div>
					<span class="stat-label"
						>{t("dashboard.activeProjects")}</span
					>
					<p class="stat-number-md">{projects.length}</p>
					<p class="text-muted-foreground arshid mt-3">
						{formatCurrency(totalProjectValue, lang)}
						{t("budget.value")}
					</p>
				</div>
				<div>
					<span class="stat-label">{t("budget.obligations")}</span>
					<p class="stat-number-md arshid">
						{yearObligations.length}
					</p>
					<p class="text-muted-foreground mt-3">
						{t("budget.commitments")}
					</p>
				</div>
			</div>
		</section>

		<!-- Active Projects Table -->
		<section>
			<div class="flex items-center justify-between mb-8">
				<h2 class="section-title mb-0!">
					{t("dashboard.activeProjects")}
				</h2>
				<a
					href={getLocalizedPath("/projects?active=true", lang)}
					class="text-base text-muted-foreground hover:text-foreground transition-colors"
				>
					{t("dashboard.viewAll")} &rarr;
				</a>
			</div>

			{
				recentProjects.length === 0 ? (
					<p class="text-muted-foreground py-16 text-center text-lg">
						{t("dashboard.noActiveProjects")}
					</p>
				) : (
					<table class="data-table">
						<thead>
							<tr>
								<th>{t("table.project")}</th>
								<th>{t("table.phase")}</th>
								<th class="text-right">{t("table.value")}</th>
							</tr>
						</thead>
						<tbody>
							{recentProjects.map((project) => (
								<tr
									class="clickable"
									onclick={`window.location.href='${getLocalizedPath(`/projects/${project.id}`, lang)}'`}
								>
									<td>
										<p class="font-medium text-lg leading-snug">
											{project.name}
										</p>
										<p class="text-muted-foreground mono mt-1">
											{project.slug || project.ref}
										</p>
									</td>
									<td class="align-middle">
										{project.expand?.phase ? (
											<span
												class="badge"
												style={`background-color: ${project.expand.phase.color}20; color: ${project.expand.phase.color};`}
											>
												{project.expand.phase.name}
											</span>
										) : (
											<span class="text-muted-foreground">
												—
											</span>
										)}
									</td>
									<td class="text-right font-medium arshid text-lg align-middle">
										{formatCurrency(
											project.total || 0,
											lang,
										)}
									</td>
								</tr>
							))}
						</tbody>
					</table>
				)
			}
		</section>

		<!-- Planned Payments Table -->
		<section>
			<div class="flex items-center justify-between mb-8">
				<h2 class="section-title mb-0!">
					{t("dashboard.plannedPayments")}
				</h2>
				<a
					href={getLocalizedPath("/payments?status=planned", lang)}
					class="text-base text-muted-foreground hover:text-foreground transition-colors"
				>
					{t("dashboard.viewAll")} &rarr;
				</a>
			</div>

			{
				plannedPayments.length === 0 ? (
					<p class="text-muted-foreground py-16 text-center text-lg">
						{t("dashboard.noPlannedPayments")}
					</p>
				) : (
					<table class="data-table">
						<thead>
							<tr>
								<th>{t("payments.payment")}</th>
								<th>{t("table.due")}</th>
								<th class="text-right">{t("table.amount")}</th>
							</tr>
						</thead>
						<tbody>
							{plannedPayments.slice(0, 5).map((payment) => (
								<tr
									class="clickable"
									onclick={`window.location.href='${getLocalizedPath(`/payments/${payment.id}`, lang)}'`}
								>
									<td>
										<p class="font-medium text-lg">
											{payment.name}
										</p>
									</td>
									<td class="text-muted-foreground align-middle">
										{payment.due_date
											? formatDate(payment.due_date, lang)
											: "—"}
									</td>
									<td class="text-right font-medium arshid text-lg align-middle">
										{formatCurrency(
											payment.amount || 0,
											lang,
										)}
									</td>
								</tr>
							))}
						</tbody>
					</table>
				)
			}
		</section>

		<!-- Recent Paid Payments Table -->
		<section>
			<div class="flex items-center justify-between mb-8">
				<h2 class="section-title mb-0!">
					{t("dashboard.recentPayments")}
				</h2>
				<a
					href={getLocalizedPath("/payments?status=paid", lang)}
					class="text-base text-muted-foreground hover:text-foreground transition-colors"
				>
					{t("dashboard.viewAll")} &rarr;
				</a>
			</div>

			{
				paidPayments.length === 0 ? (
					<p class="text-muted-foreground py-16 text-center text-lg">
						{t("dashboard.noPaymentsThisYear")}
					</p>
				) : (
					<table class="data-table">
						<thead>
							<tr>
								<th>{t("table.ref")}</th>
								<th>{t("table.date")}</th>
								<th class="text-right">{t("table.amount")}</th>
							</tr>
						</thead>
						<tbody>
							{paidPayments.slice(0, 5).map((payment) => (
								<tr
									class="clickable"
									onclick={`window.location.href='${getLocalizedPath(`/payments/${payment.id}`, lang)}'`}
								>
									<td class="mono text-muted-foreground align-middle">
										{payment.ref || "—"}
									</td>
									<td class="text-muted-foreground align-middle">
										{formatDate(payment.created, lang)}
									</td>
									<td class="text-right font-medium arshid text-lg align-middle">
										{formatCurrency(
											payment.amount || 0,
											lang,
										)}
									</td>
								</tr>
							))}
						</tbody>
					</table>
				)
			}
		</section>
	</div>
</Layout>
