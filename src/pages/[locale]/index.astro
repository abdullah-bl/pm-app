---
import Layout from "@/layouts/Layout.astro";
import type { Project, Bill, BudgetItem, Obligation, Payment } from "@/types";
import {
	getLangFromUrl,
	useTranslations,
	getLocalizedPath,
	formatCurrency,
	formatDate,
} from "@/i18n/utils";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const pb = Astro.locals.pb;

const currentYear = new Date().getFullYear();
const yearStart = `${currentYear}-01-01`;
const yearEnd = `${currentYear}-12-31`;

let projects: Project[] = [];
let bills: Bill[] = [];
let budgetItems: BudgetItem[] = [];
let obligations: Obligation[] = [];
let payments: Payment[] = [];

try {
	const [projectsRes, billsRes, budgetItemsRes, obligationsRes, paymentsRes] =
		await Promise.all([
			pb.collection("projects").getFullList<Project>({
				sort: "-created",
				filter: "active=true",
				expand: "phase",
			}),
			pb.collection("bills").getFullList<Bill>({
				sort: "due_date",
			}),
			pb.collection("budget_items").getFullList<BudgetItem>({
				filter: `year=${currentYear}`,
			}),
			pb.collection("obligations").getFullList<Obligation>({
				sort: "-date",
			}),
			pb.collection("payments").getFullList<Payment>({
				sort: "-created",
			}),
		]);

	projects = projectsRes;
	bills = billsRes;
	budgetItems = budgetItemsRes;
	obligations = obligationsRes;
	payments = paymentsRes;
} catch (e) {
	console.error("Error fetching dashboard data:", e);
}

// Filter data for current year
const yearObligations = obligations.filter((o) => {
	const date = o.date || o.created;
	return date >= yearStart && date <= yearEnd;
});

const yearPayments = payments.filter((p) => {
	const date = p.created;
	return date >= yearStart && date <= yearEnd;
});

const now = new Date();
const upcomingBills = bills.filter(
	(b) => b.due_date && new Date(b.due_date) >= now,
);
const recentProjects = projects.slice(0, 5);

// Calculate totals for this year
const totalBudgetCash = budgetItems.reduce(
	(sum, item) => sum + (item.cash || 0),
	0,
);
const totalBudgetCost = budgetItems.reduce(
	(sum, item) => sum + (item.cost || 0),
	0,
);
const totalObligatedCash = yearObligations.reduce(
	(sum, o) => sum + (o.cash || 0),
	0,
);
const totalObligatedCost = yearObligations.reduce(
	(sum, o) => sum + (o.cost || 0),
	0,
);
const totalPaid = yearPayments.reduce((sum, p) => sum + (p.amount || 0), 0);
const totalBills = upcomingBills.reduce((sum, b) => sum + (b.amount || 0), 0);
const totalProjectValue = projects.reduce((sum, p) => sum + (p.total || 0), 0);
const budgetRemainingCash = totalBudgetCash - totalObligatedCash;
const budgetRemainingCost = totalBudgetCost - totalObligatedCost;
---

<Layout>
	<div class="space-y-20 md:space-y-28">
		<!-- Header -->
		<section>
			<p class="section-title mb-3">
				{currentYear}
				{t("dashboard.overview")}
			</p>
			<h1 class="page-title">{t("dashboard.title")}</h1>
		</section>

		<!-- Budget Summary - Primary Stats -->
		<section>
			<h2 class="section-title">{t("dashboard.budgetSummary")}</h2>
			<div class="grid grid-cols-1 md:grid-cols-3 gap-12 md:gap-16">
				<!-- Cash Budget -->
				<div>
					<span class="stat-label">{t("budget.cash")}</span>
					<p class="stat-number arshid">
						{formatCurrency(totalBudgetCash, lang)}
					</p>
				</div>
				<!-- Obligated -->
				<div>
					<span class="stat-label">{t("budget.obligatedCash")}</span>
					<p class="stat-number arshid">
						{formatCurrency(totalObligatedCash, lang)}
					</p>
				</div>
				<!-- Remaining -->
				<div>
					<span class="stat-label">{t("budget.remainingCash")}</span>
					<p
						class:list={[
							"stat-number arshid",
							budgetRemainingCash < 0
								? "text-destructive"
								: "text-emerald-600",
						]}
					>
						{formatCurrency(budgetRemainingCash, lang)}
					</p>
				</div>
			</div>

			<!-- Cost Budget - Secondary Stats -->
			<div
				class="grid grid-cols-1 md:grid-cols-3 gap-8 md:gap-16 mt-12 pt-8 border-t border-border"
			>
				<div>
					<span class="stat-label">{t("budget.cost")}</span>
					<p class="stat-number-md arshid">
						{formatCurrency(totalBudgetCost, lang)}
					</p>
				</div>
				<div>
					<span class="stat-label">{t("budget.obligatedCost")}</span>
					<p class="stat-number-md arshid">
						{formatCurrency(totalObligatedCost, lang)}
					</p>
				</div>
				<div>
					<span class="stat-label">{t("budget.remainingCost")}</span>
					<p class="stat-number-md arshid">
						{formatCurrency(budgetRemainingCost, lang)}
					</p>
				</div>
			</div>
		</section>

		<!-- Activity Stats -->
		<section>
			<h2 class="section-title">{t("dashboard.activity")}</h2>
			<div class="grid grid-cols-2 md:grid-cols-4 gap-10 md:gap-16">
				<div>
					<span class="stat-label">{t("budget.payments")}</span>
					<p class="stat-number-md arshid">
						{formatCurrency(totalPaid, lang)}
					</p>
					<p class="text-sm text-muted-foreground mt-2">
						{yearPayments.length}
						{t("budget.transactions")}
					</p>
				</div>
				<div>
					<span class="stat-label">{t("budget.obligations")}</span>
					<p class="stat-number-md arshid">
						{yearObligations.length}
					</p>
					<p class="text-sm text-muted-foreground mt-2">
						{t("budget.commitments")}
					</p>
				</div>
				<div>
					<span class="stat-label"
						>{t("dashboard.upcomingBills")}</span
					>
					<p class="stat-number-md arshid">
						{formatCurrency(totalBills, lang)}
					</p>
					<p class="text-sm text-muted-foreground mt-2">
						{upcomingBills.length}
						{t("budget.pending")}
					</p>
				</div>
				<div>
					<span class="stat-label"
						>{t("dashboard.activeProjects")}</span
					>
					<p class="stat-number-md">{projects.length}</p>
					<p class="text-sm text-muted-foreground mt-2">
						{formatCurrency(totalProjectValue, lang)}
						{t("budget.value")}
					</p>
				</div>
			</div>
		</section>

		<!-- Recent Projects -->
		<section>
			<div class="flex items-center justify-between mb-6">
				<h2 class="section-title mb-0!">
					{t("dashboard.activeProjects")}
				</h2>
				<a
					href={getLocalizedPath("/projects?active=true", lang)}
					class="text-sm text-muted-foreground hover:text-foreground transition-colors"
				>
					{t("dashboard.viewAll")} →
				</a>
			</div>

			{
				recentProjects.length === 0 ? (
					<p class="text-muted-foreground py-12 text-center">
						{t("dashboard.noActiveProjects")}
					</p>
				) : (
					<table class="data-table">
						<thead>
							<tr>
								<th>{t("table.project")}</th>
								<th>{t("table.phase")}</th>
								<th class="text-right">{t("table.value")}</th>
							</tr>
						</thead>
						<tbody>
							{recentProjects.map((project) => (
								<tr>
									<td>
										<p class="font-medium text-base leading-snug">
											{project.name}
										</p>
										<p class="text-sm text-muted-foreground mono mt-1">
											{project.slug || project.ref}
										</p>
									</td>
									<td class="align-middle">
										{project.expand?.phase ? (
											<span
												class="badge"
												style={`background-color: ${project.expand.phase.color}20; color: ${project.expand.phase.color};`}
											>
												{project.expand.phase.name}
											</span>
										) : (
											<span class="text-muted-foreground">
												—
											</span>
										)}
									</td>
									<td class="text-right font-medium arshid text-base align-middle">
										{formatCurrency(
											project.total || 0,
											lang,
										)}
									</td>
								</tr>
							))}
						</tbody>
					</table>
				)
			}
		</section>

		<!-- Upcoming Bills -->
		<section>
			<div class="flex items-center justify-between mb-6">
				<h2 class="section-title mb-0!">
					{t("dashboard.upcomingBills")}
				</h2>
				<a
					href={getLocalizedPath("/bills", lang)}
					class="text-sm text-muted-foreground hover:text-foreground transition-colors"
				>
					{t("dashboard.viewAll")} →
				</a>
			</div>

			{
				upcomingBills.length === 0 ? (
					<p class="text-muted-foreground py-12 text-center">
						{t("dashboard.noUpcomingBills")}
					</p>
				) : (
					<table class="data-table">
						<thead>
							<tr>
								<th>{t("table.bill")}</th>
								<th>{t("table.due")}</th>
								<th class="text-right">{t("table.amount")}</th>
							</tr>
						</thead>
						<tbody>
							{upcomingBills.slice(0, 5).map((bill) => (
								<tr>
									<td>
										<p class="font-medium text-base">
											{bill.name}
										</p>
										{bill.note && (
											<p class="text-sm text-muted-foreground line-clamp-1 mt-1">
												{bill.note}
											</p>
										)}
									</td>
									<td class="text-muted-foreground align-middle">
										{bill.due_date
											? formatDate(bill.due_date, lang)
											: "—"}
									</td>
									<td class="text-right font-medium arshid text-base align-middle">
										{formatCurrency(bill.amount || 0, lang)}
									</td>
								</tr>
							))}
						</tbody>
					</table>
				)
			}
		</section>

		<!-- Recent Payments -->
		<section>
			<div class="flex items-center justify-between mb-6">
				<h2 class="section-title mb-0!">
					{t("dashboard.recentPayments")}
				</h2>
				<a
					href={getLocalizedPath("/budget", lang)}
					class="text-sm text-muted-foreground hover:text-foreground transition-colors"
				>
					{t("dashboard.viewAll")} →
				</a>
			</div>

			{
				yearPayments.length === 0 ? (
					<p class="text-muted-foreground py-12 text-center">
						{t("dashboard.noPaymentsThisYear")}
					</p>
				) : (
					<table class="data-table">
						<thead>
							<tr>
								<th>{t("table.ref")}</th>
								<th>{t("table.date")}</th>
								<th class="text-right">{t("table.amount")}</th>
							</tr>
						</thead>
						<tbody>
							{yearPayments.slice(0, 5).map((payment) => (
								<tr>
									<td class="mono text-muted-foreground align-middle">
										{payment.ref || "—"}
									</td>
									<td class="text-muted-foreground align-middle">
										{formatDate(payment.created, lang)}
									</td>
									<td class="text-right font-medium arshid text-base align-middle">
										{formatCurrency(
											payment.amount || 0,
											lang,
										)}
									</td>
								</tr>
							))}
						</tbody>
					</table>
				)
			}
		</section>
	</div>
</Layout>
